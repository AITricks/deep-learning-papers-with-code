## ç»“æ„å›¾è¯¦ç»†è§£è¯»

![ç»“æ„å›¾](https://gitee.com/ChadHui/typora-image/raw/master/cv-image/20251019152942.jpg)

### ä¸ŠåŠéƒ¨åˆ†ï¼šAKConvæ•´ä½“æ•°æ®æµ

**1. è¾“å…¥ (Input)**
- è¾“å…¥å¼ é‡ç»´åº¦ï¼š`C, H, W`
- å¯¹åº”ä»£ç ï¼š`def forward(self, x)` ä¸­çš„è¾“å…¥å‚æ•° `x`

**2. åç§»é‡ç”Ÿæˆè·¯å¾„ (Offset Generation Path)**
- **Conv2då±‚**ï¼šç”Ÿæˆåç§»é‡
- **è¾“å‡º**ï¼š`Offset` å¼ é‡ï¼ŒåŒ…å«å¯å­¦ä¹ çš„äºŒç»´åç§»é‡
- å¯¹åº”ä»£ç ï¼š
```python
self.p_conv = nn.Conv2d(inc, 2 * num_param, kernel_size=3, padding=1, stride=stride)
offset = self.p_conv(x)  # ç¬¬19è¡Œ
```

**3. ä¸»æ•°æ®å¤„ç†è·¯å¾„ (Main Data Processing Path)**
- **Resampleæ¨¡å—**ï¼šæ¥æ”¶è¾“å…¥å’Œåç§»é‡ï¼Œè¿›è¡Œè‡ªé€‚åº”é‡‡æ ·
- å¯¹åº”ä»£ç ä¸­çš„æ ¸å¿ƒé‡é‡‡æ ·é€»è¾‘ï¼ˆç¬¬46-56è¡Œï¼‰ï¼š
```python
# åŒçº¿æ€§æ’å€¼é‡é‡‡æ ·
x_offset = g_lt.unsqueeze(dim=1) * x_q_lt + \
           g_rb.unsqueeze(dim=1) * x_q_rb + \
           g_lb.unsqueeze(dim=1) * x_q_lb + \
           g_rt.unsqueeze(dim=1) * x_q_rt
```

**4. æœ€ç»ˆè¾“å‡ºå±‚**
- **Reshape** â†’ **Conv** â†’ **Norm** â†’ **SiLU**
- å¯¹åº”ä»£ç ï¼ˆç¬¬6è¡Œå’Œç¬¬58-59è¡Œï¼‰ï¼š
```python
self.conv = nn.Sequential(
    nn.Conv2d(inc, outc, kernel_size=(num_param, 1), stride=(num_param, 1), bias=bias),
    nn.BatchNorm2d(outc),
    nn.SiLU()
)
x_offset = self._reshape_x_offset(x_offset, self.num_param)  # Reshape
out = self.conv(x_offset)  # Conv + Norm + SiLU
```

### ä¸‹åŠéƒ¨åˆ†ï¼šåæ ‡ä¿®æ”¹æœºåˆ¶

**1. åç§»é‡ (Offset)**
- åŒ…å«6ä¸ªåç§»å€¼ï¼Œå¯¹åº”æ¯ä¸ªé‡‡æ ·ç‚¹çš„(x,y)åç§»
- å¯¹åº”ä»£ç ï¼š`offset = self.p_conv(x)` çš„è¾“å‡º

**2. åŸå§‹åæ ‡ (Original Coordinate)**
- é¢„å®šä¹‰çš„å›ºå®šåˆå§‹é‡‡æ ·åæ ‡
- å¯¹åº”ä»£ç ï¼š`self.p_n` ç¼“å†²åŒºï¼ˆç¬¬10è¡Œï¼‰ï¼Œé€šè¿‡`_get_p_n`æ–¹æ³•ç”Ÿæˆï¼ˆç¬¬64-83è¡Œï¼‰

**3. åŠ æ³•æ“ä½œ (+)**
- å°†åç§»é‡åŠ åˆ°åŸå§‹åæ ‡ä¸Š
- å¯¹åº”ä»£ç ï¼ˆç¬¬104è¡Œï¼‰ï¼š
```python
p = p_0 + self.p_n + offset
```

**4. ä¿®æ”¹åçš„åæ ‡ (Modified Coordinate)**
- å®é™…ç”¨äºé‡‡æ ·çš„åæ ‡
- å¯¹åº”ä»£ç ï¼š`p` å˜é‡ï¼Œç»è¿‡åæ ‡å˜æ¢åç”¨äºåŒçº¿æ€§æ’å€¼

## ä¸model.pyçš„å¯¹åº”å…³ç³»åˆ†æ

### âœ… é«˜åº¦å¯¹åº”çš„éƒ¨åˆ†ï¼š

1. **åç§»é‡ç”Ÿæˆ**ï¼šç»“æ„å›¾ä¸­çš„Conv2då®Œå…¨å¯¹åº”`self.p_conv`
2. **åæ ‡è®¡ç®—**ï¼šç»“æ„å›¾çš„ä¸‹åŠéƒ¨åˆ†å®Œå…¨å¯¹åº”`_get_p`æ–¹æ³•
3. **é‡é‡‡æ ·**ï¼šç»“æ„å›¾çš„Resampleæ¨¡å—å¯¹åº”åŒçº¿æ€§æ’å€¼é€»è¾‘
4. **æœ€ç»ˆå¤„ç†**ï¼šReshapeâ†’Convâ†’Normâ†’SiLUå®Œå…¨å¯¹åº”`self.conv`åºåˆ—

### âš ï¸ éœ€è¦æ³¨æ„çš„å·®å¼‚ï¼š

1. **è¾“å‡ºç»´åº¦**ï¼šç»“æ„å›¾æ˜¾ç¤º`C, 5, H, W`ï¼Œä½†ä»£ç ä¸­å®é™…æ˜¯`C, num_param, H, W`ï¼Œå…¶ä¸­`num_param`æ˜¯å¯é…ç½®çš„
2. **é‡‡æ ·ç‚¹æ•°é‡**ï¼šç»“æ„å›¾æ˜¾ç¤º6ä¸ªé‡‡æ ·ç‚¹ï¼Œä»£ç ä¸­`num_param`å¯ä»¥æ˜¯ä»»æ„å€¼
3. **å®ç°ç»†èŠ‚**ï¼šä»£ç ä½¿ç”¨äº†æ›´å¤æ‚çš„åŒçº¿æ€§æ’å€¼å®ç°ï¼ŒåŒ…æ‹¬å››ä¸ªè§’ç‚¹çš„è®¡ç®—

### ğŸ” æ ¸å¿ƒå¯¹åº”å…³ç³»æ€»ç»“ï¼š

| ç»“æ„å›¾ç»„ä»¶ | ä»£ç å¯¹åº” | è¡Œå· |
|-----------|---------|------|
| Input | `x` å‚æ•° | 17 |
| Conv2d (Offset) | `self.p_conv` | 7, 19 |
| Original Coordinate | `self.p_n` | 10 |
| Modified Coordinate | `p` å˜é‡ | 104 |
| Resample | åŒçº¿æ€§æ’å€¼é€»è¾‘ | 46-56 |
| Reshape | `_reshape_x_offset` | 58, 134 |
| Conv+Norm+SiLU | `self.conv` | 6, 59 |

**ç»“è®º**ï¼šè¿™ä¸ªç»“æ„å›¾ä¸`model.py`ä¸­çš„LDConvå®ç°**é«˜åº¦å¯¹åº”**ï¼Œå®Œç¾åœ°å±•ç¤ºäº†è‡ªé€‚åº”å·ç§¯çš„æ ¸å¿ƒæ€æƒ³ï¼šé€šè¿‡å­¦ä¹ åç§»é‡æ¥åŠ¨æ€è°ƒæ•´é‡‡æ ·ä½ç½®ï¼Œå®ç°è‡ªé€‚åº”çš„ç‰¹å¾æå–ã€‚ä»£ç å®ç°æ¯”ç»“æ„å›¾æ›´åŠ è¯¦ç»†å’Œå®Œæ•´ï¼ŒåŒ…å«äº†åŒçº¿æ€§æ’å€¼çš„å…·ä½“å®ç°ç»†èŠ‚ã€‚